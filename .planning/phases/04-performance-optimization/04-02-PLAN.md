---
phase: 04-performance-optimization
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified: [package.json, package-lock.json]
autonomous: false

must_haves:
  truths:
    - "Production bundle contains no unused Cloudinary packages"
    - "Page loads in under 3 seconds on Fast 3G throttled connection"
    - "Lighthouse mobile performance score is 80 or higher"
    - "Bundle size is optimized with dead code eliminated"
  artifacts:
    - path: "package.json"
      provides: "Dependencies list with unused packages removed"
      min_lines: 30
    - path: ".planning/phases/04-performance-optimization/04-PERFORMANCE-REPORT.md"
      provides: "Performance test results documenting Fast 3G and Lighthouse scores"
      contains: "Lighthouse"
      min_lines: 20
  key_links:
    - from: "package.json"
      to: "production bundle"
      via: "unused packages removed"
      pattern: "(?!.*cloudinary|(?!.*next-cloudinary))"
    - from: "Lighthouse mobile score"
      to: "PERF-02 requirement"
      via: "score >= 80"
      pattern: "performance.*[8-9][0-9]|100"
---

<objective>
Analyze bundle size, remove unused packages, and verify all performance requirements are met.

Purpose: Complete the performance optimization phase by eliminating bundle bloat and validating that the site meets Fast 3G and Lighthouse mobile score requirements for rural Missouri audience.

Output: Clean production bundle, performance test report documenting Fast 3G load times and Lighthouse mobile score.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
@/home/evan/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/phase-4-RESEARCH.md
@.planning/codebase/CONCERNS.md
@.planning/REQUIREMENTS.md

@.planning/phases/04-performance-optimization/04-01-SUMMARY.md

@package.json
@next.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze Bundle and Remove Unused Packages</name>
  <files>package.json, package-lock.json</files>
  <action>
    Run bundle analyzer to identify bloated dependencies:
    - Execute: `ANALYZE=true npm run build`
    - Open generated reports: `.next/analyze/client.html` and `.next/analyze/nodejs.html`
    - Look for: cloudinary packages, icon libraries, any large unexpected dependencies

    Check if Cloudinary packages are actually used in the codebase:
    - Search for cloudinary imports: `grep -r "from 'cloudinary'" src/`
    - Search for next-cloudinary imports: `grep -r "from 'next-cloudinary'" src/`
    - Search for CldImage usage: `grep -r "CldImage" src/`

    Based on findings:

    If cloudinary/next-cloudinary are NOT used (imports commented out or absent):
    - Remove packages: `npm uninstall cloudinary next-cloudinary`
    - Reasoning: CONCERNS.md indicates Cloudinary imports are commented out. If Phase 2 didn't complete the migration, these packages are pure bloat (cloudinary is 2.5.1, next-cloudinary is 6.16.0 - both add significant bundle size).

    If cloudinary/next-cloudinary ARE used (Phase 2 completed migration):
    - Keep packages, they're actively providing value
    - Verify CldImage is used with proper optimization settings

    Remove any other unused dependencies identified by bundle analyzer:
    - Check for unused icon libraries (react-icons, lucide-react, @heroicons/react)
    - Use: `grep -r "from 'PACKAGE_NAME'" src/` to confirm usage before removing

    Document findings in verification step.

    Why check actual usage: Bundle analyzer shows what's in the bundle, but we need to verify if it's used. Phase 2's status is unclear - if it switched back to file-based storage, Cloudinary packages are unused bloat.
  </action>
  <verify>
    npm run build
    npm list cloudinary next-cloudinary 2>/dev/null || echo "Cloudinary packages removed (expected if unused)"
    grep -r "from 'cloudinary'" src/ && echo "ERROR: cloudinary imported but package may be removed" || echo "PASS: no cloudinary imports found"
  </verify>
  <done>
    - Bundle analysis completed and reports generated
    - Unused packages identified and removed from package.json
    - package-lock.json regenerated with clean dependency tree
    - Build succeeds with smaller bundle size
    - No broken imports (all remaining dependencies are actively used)
  </done>
</task>

<task type="auto">
  <name>Task 2: Run Lighthouse Performance Tests</name>
  <files>.planning/phases/04-performance-optimization/04-PERFORMANCE-REPORT.md</files>
  <action>
    Start production build and server:
    - Build: `npm run build` (production build with optimizations)
    - Start: `npm run start` in background
    - Wait for server ready on port 3000

    Run Lighthouse audit with mobile throttling (Fast 3G simulation):
    - Install Lighthouse if needed: `npx lighthouse --version` (will auto-install)
    - Run audit: `npx lighthouse http://localhost:3000 --preset=mobile --throttling-method=devtools --output=json --output=html --output-path=./.next/lighthouse-report`
    - Mobile preset includes: Fast 3G throttling (1.6Mbps down, 750Kbps up, 150ms RTT), CPU slowdown 4x

    Extract key metrics from JSON report:
    - Performance score (target: >= 80)
    - Largest Contentful Paint (target: < 2.5s)
    - First Contentful Paint (target: < 2s)
    - Total Blocking Time (target: < 300ms)
    - Cumulative Layout Shift (target: < 0.1)

    Create performance report in `.planning/phases/04-performance-optimization/04-PERFORMANCE-REPORT.md` with:
    ```markdown
    # Phase 4: Performance Test Report

    **Test Date:** [current date]
    **Environment:** Production build (npm run start)
    **Throttling:** Fast 3G (mobile preset)

    ## Requirements Status

    - [x/☐] PERF-01: Page loads < 3s on Fast 3G → [X.Xs measured]
    - [x/☐] PERF-02: Lighthouse mobile score >= 80 → [XX measured]
    - [x/☐] PERF-03: Responsive image sizing → [implemented in 04-01]
    - [x/☐] PERF-04: No unused packages → [list removed packages]

    ## Lighthouse Mobile Score

    Performance: XX/100

    ### Core Web Vitals
    - LCP: X.Xs (target < 2.5s)
    - FCP: X.Xs (target < 2.0s)
    - TBT: XXXms (target < 300ms)
    - CLS: X.XX (target < 0.1)

    ## Bundle Size Analysis

    Client bundle: XX KB (before: XX KB)
    Reduction: XX KB / XX%

    Packages removed:
    - [list packages removed in Task 1]

    ## Screenshots

    HTML report: `.next/lighthouse-report.html`
    JSON report: `.next/lighthouse-report.json`
    ```

    If performance score < 80 or load time > 3s:
    - Document the failing metrics
    - Identify top issues from Lighthouse report
    - This becomes input for potential gap closure plan

    Stop the production server after testing.
  </action>
  <verify>
    test -f .planning/phases/04-performance-optimization/04-PERFORMANCE-REPORT.md || echo "ERROR: Performance report missing"
    test -f .next/lighthouse-report.html || echo "ERROR: Lighthouse HTML report missing"
    grep -q "Performance:" .planning/phases/04-performance-optimization/04-PERFORMANCE-REPORT.md || echo "ERROR: Score missing from report"
  </verify>
  <done>
    - Production build created and tested
    - Lighthouse audit completed with mobile throttling
    - Performance report created documenting all metrics
    - All PERF requirements (01-04) status documented
    - Server stopped cleanly after testing
  </done>
</task>

<task type="auto">
  <name>Task 3: Start Development Server</name>
  <files></files>
  <action>
    Start the Next.js development server for visual verification:
    - Run `npm run dev` in background
    - Wait for "Ready" message indicating server is running
    - Server should be accessible at http://localhost:3000

    This server will be used in the checkpoint task for visual verification of image optimization and responsive behavior.
  </action>
  <verify>
    curl -s http://localhost:3000 | grep -q "<!DOCTYPE html" || echo "ERROR: Dev server not responding"
  </verify>
  <done>
    - Dev server running at http://localhost:3000
    - Homepage loads without errors
    - Ready for visual verification checkpoint
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Performance-optimized site with responsive images and cleaned bundle.

    Development server running at: http://localhost:3000

    Optimizations implemented:
    - Next.js image optimization enabled (Sharp processing)
    - Gallery images with responsive sizing (mobile/tablet/desktop)
    - Hero image with priority loading
    - Unused packages removed from bundle
    - Lighthouse mobile score tested and documented
  </what-built>
  <how-to-verify>
    Visit http://localhost:3000 and verify:

    1. **Homepage Load Time**
       - Open Chrome DevTools (F12) → Network tab
       - Enable "Fast 3G" throttling (Network throttle dropdown)
       - Hard refresh (Ctrl+Shift+R or Cmd+Shift+R)
       - Verify page becomes interactive within 3 seconds

    2. **Gallery Image Responsiveness**
       - Scroll to Gallery section
       - Open DevTools → Network tab → Img filter
       - Resize browser window from mobile (375px) to desktop (1920px)
       - Verify: Different image sizes load at different viewport widths (check image file sizes in Network tab)
       - Images should NOT all be same file size across breakpoints

    3. **Hero Image Loading**
       - Reload page and watch Network tab
       - Hero image should load early (high priority in waterfall)
       - Should appear before below-fold gallery images

    4. **Modern Image Formats**
       - Network tab → Img filter
       - Click on gallery images
       - Headers → Response Headers → Content-Type
       - Should see: `image/webp` or `image/avif` (depending on browser)
       - NOT: `image/jpeg` or `image/png` for optimized images

    5. **Visual Quality**
       - Gallery images appear crisp and clear
       - Hero image has no visible compression artifacts
       - No layout shift as images load
       - Smooth lazy loading as you scroll

    6. **Performance Report Review**
       - Open `.planning/phases/04-performance-optimization/04-PERFORMANCE-REPORT.md`
       - Verify Lighthouse mobile score >= 80
       - Verify page load time < 3s on Fast 3G
       - Verify all PERF-01 through PERF-04 requirements marked as complete

    Visual checks only - all testing has been automated in previous tasks.
  </how-to-verify>
  <resume-signal>
    Type "approved" if all verifications pass, or describe specific issues if any checks fail.
  </resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Bundle analyzer reports generated and reviewed
- [ ] Unused packages removed from package.json and package-lock.json
- [ ] Production build completes successfully
- [ ] Lighthouse audit completed with mobile throttling
- [ ] Performance report created with all metrics documented
- [ ] All PERF requirements (01-04) addressed
- [ ] Human verification checkpoint passed
- [ ] Dev server stopped after verification
</verification>

<success_criteria>
- All tasks completed
- Bundle is optimized with unused packages removed
- Lighthouse mobile performance score >= 80 (PERF-02)
- Page loads in < 3 seconds on Fast 3G (PERF-01)
- Performance report documents all metrics and requirement status
- Visual verification confirms responsive images and optimization working
- All Phase 4 requirements (PERF-01 through PERF-04) are met
</success_criteria>

<output>
After completion, create `.planning/phases/04-performance-optimization/04-02-SUMMARY.md`
</output>
