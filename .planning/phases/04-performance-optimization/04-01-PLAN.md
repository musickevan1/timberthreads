---
phase: 04-performance-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [next.config.js, src/components/Gallery.tsx, src/components/Hero.tsx, package.json]
autonomous: true

must_haves:
  truths:
    - "Gallery images are served with responsive sizing based on viewport width"
    - "Hero image uses priority loading for Largest Contentful Paint optimization"
    - "Next.js image optimization is enabled (Sharp processing active)"
    - "Images are delivered in modern formats (WebP/AVIF) based on browser support"
  artifacts:
    - path: "next.config.js"
      provides: "Next.js image optimization configuration"
      contains: "remotePatterns"
      min_lines: 20
    - path: "src/components/Gallery.tsx"
      provides: "Gallery component with responsive image sizing"
      contains: "sizes="
      min_lines: 100
    - path: "src/components/Hero.tsx"
      provides: "Hero component with priority loading"
      contains: "priority"
      min_lines: 50
  key_links:
    - from: "next.config.js"
      to: "Sharp image processing"
      via: "images.unoptimized removed"
      pattern: "(?<!unoptimized)"
    - from: "src/components/Gallery.tsx"
      to: "responsive image delivery"
      via: "sizes attribute for mobile/tablet/desktop"
      pattern: 'sizes="\(max-width:'
    - from: "src/components/Hero.tsx"
      to: "LCP optimization"
      via: "priority attribute"
      pattern: "priority(?:=\\{true\\}|\\s)"
---

<objective>
Enable Next.js image optimization and implement responsive image sizing for mobile-first delivery.

Purpose: Fix foundational image performance issues that are currently blocking all optimization. The current `images.unoptimized: true` setting disables Sharp processing, prevents responsive srcset generation, and blocks modern format conversion (WebP/AVIF).

Output: Fully optimized image delivery system with responsive sizing for gallery and priority loading for hero image.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/phase-4-RESEARCH.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/CONVENTIONS.md

@next.config.js
@src/components/Gallery.tsx
@src/components/Hero.tsx
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable Next.js Image Optimization</name>
  <files>next.config.js, package.json</files>
  <action>
    Remove `images.unoptimized: true` from next.config.js to enable Sharp image processing.

    Update remotePatterns to use specific Cloudinary hostname instead of wildcard:
    - Change `hostname: '**'` to `hostname: 'res.cloudinary.com'`
    - Keep `protocol: 'https'`

    Update Content-Security-Policy header to include Cloudinary in media-src and img-src:
    - Add `https://res.cloudinary.com` to existing img-src directive
    - Add `media-src 'self' https://res.cloudinary.com;` directive

    Install @next/bundle-analyzer as dev dependency:
    - `npm install -D @next/bundle-analyzer`
    - Wrap nextConfig with withBundleAnalyzer (enabled when ANALYZE=true)
    - Add `optimizePackageImports: ['react-icons', 'lucide-react']` if icon libraries are detected in codebase

    Verify Sharp is installed and at correct version (0.33.5+):
    - Run `npm list sharp` to confirm installation
    - If missing, run `npm install sharp` (should already be installed per package.json)

    Why avoid `images.unoptimized: true`: This setting disables ALL Next.js image optimization including automatic responsive srcset, WebP/AVIF format conversion, and Sharp processing. It was likely added during development to avoid Sharp installation issues but should never be used in production.

    Why avoid wildcard hostname: Security best practice. Wildcard `**` allows any domain, creating potential XSS vectors. Use specific domains only.
  </action>
  <verify>
    npm run build
    grep -q "unoptimized" next.config.js && echo "ERROR: unoptimized still present" || echo "PASS: unoptimized removed"
    grep -q "res.cloudinary.com" next.config.js || echo "ERROR: Cloudinary hostname missing"
  </verify>
  <done>
    - next.config.js has `images` object without `unoptimized` property
    - remotePatterns specifies `res.cloudinary.com` (not wildcard)
    - CSP headers include Cloudinary domains in img-src and media-src
    - @next/bundle-analyzer installed and configured
    - Build completes without Sharp-related errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Responsive Image Sizing to Gallery Component</name>
  <files>src/components/Gallery.tsx</files>
  <action>
    Update Gallery component to use responsive `sizes` attribute for mobile-first delivery.

    For gallery grid images (facilityImages and quiltingImages arrays):
    - Add `sizes` attribute with mobile-first breakpoints:
      `sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"`
    - Reasoning: Mobile (≤768px) = full width, Tablet (≤1200px) = 2 columns (50vw), Desktop = 3 columns (33vw)

    For first 6 gallery images:
    - Use `loading="eager"` (above-fold on desktop)

    For remaining gallery images (index >= 6):
    - Use `loading="lazy"` (below-fold, load on scroll)

    Keep existing image properties (width, height, alt, className).

    Do NOT add `priority` to gallery images. Priority is reserved for single LCP candidate (hero image).

    Why avoid priority on multiple images: Adding `priority` to multiple images creates multiple preload link tags, slowing First Contentful Paint by forcing browser to download all priority images before rendering content.

    Why these specific breakpoints: Based on actual gallery layout - grid changes from 1 column (mobile) to 2 columns (tablet) to 3 columns (desktop). Browser uses `sizes` attribute to select optimal image size from srcset.
  </action>
  <verify>
    grep -q 'sizes="(max-width: 768px)' src/components/Gallery.tsx || echo "ERROR: sizes attribute missing"
    grep -q 'loading="eager"' src/components/Gallery.tsx || echo "ERROR: eager loading missing"
    grep -q 'loading="lazy"' src/components/Gallery.tsx || echo "ERROR: lazy loading missing"
    npm run build
  </verify>
  <done>
    - Gallery images have `sizes` attribute with mobile/tablet/desktop breakpoints
    - First 6 images use `loading="eager"`
    - Remaining images use `loading="lazy"`
    - TypeScript compilation passes
    - No `priority` attribute on gallery images
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Priority Loading to Hero Image</name>
  <files>src/components/Hero.tsx</files>
  <action>
    Update Hero component to optimize Largest Contentful Paint (LCP).

    For the hero background image (main hero image, typically the largest above-fold element):
    - Add `priority` attribute (or `priority={true}`)
    - Keep existing `sizes="100vw"` (hero is full-width)
    - Reduce `quality` from 100 to 85 if currently set to 100 (quality=100 is overkill for web, 85 is balanced)

    Remove `loading="eager"` if present (redundant with `priority`).

    Only add `priority` to ONE image per page - the true LCP candidate (largest above-fold image).

    Why priority for hero only: The `priority` attribute inserts a preload link in the document head, telling the browser to fetch this image immediately. Using priority on multiple images creates waterfall of blocking requests that delays page render.

    Why quality=85 instead of 100: Human eye cannot distinguish quality above 85 for most web images. Quality 100 significantly increases file size (often 2-3x larger) with imperceptible visual improvement. Research shows quality 75-85 is optimal balance.
  </action>
  <verify>
    grep -q "priority" src/components/Hero.tsx || echo "ERROR: priority attribute missing"
    npm run build
  </verify>
  <done>
    - Hero image has `priority` attribute
    - Hero image quality is 85 or lower (not 100)
    - Hero image has `sizes="100vw"` (full-width)
    - TypeScript compilation passes
    - Only ONE image in the component has `priority`
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` completes without errors
- [ ] `next.config.js` does NOT contain `unoptimized: true`
- [ ] `next.config.js` remotePatterns specifies `res.cloudinary.com` (not wildcard)
- [ ] Gallery component has `sizes` attribute on images
- [ ] Gallery component uses `loading="eager"` for first 6 images, `loading="lazy"` for rest
- [ ] Hero component has `priority` attribute on LCP candidate
- [ ] @next/bundle-analyzer is installed in devDependencies
- [ ] No build warnings about image optimization
</verification>

<success_criteria>
- All tasks completed
- Next.js image optimization is fully enabled
- Gallery images have responsive sizing for mobile/tablet/desktop
- Hero image uses priority loading for LCP optimization
- Build completes successfully with no optimization-related errors
- Bundle analyzer configured for use in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/04-performance-optimization/04-01-SUMMARY.md`
</output>
