---
phase: 02-gallery-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/migrate-gallery-to-cloudinary.ts
  - scripts/init-vercel-kv.ts
  - src/app/api/gallery/route.ts
  - src/app/api/gallery/types.ts
  - src/components/Gallery.tsx
  - next.config.js
autonomous: true

must_haves:
  truths:
    - "All 12 existing gallery images are hosted on Cloudinary CDN"
    - "Gallery displays images from Cloudinary with automatic format optimization (WebP/AVIF)"
    - "Gallery lazy-loads images below the fold (first 6 eager, rest lazy)"
    - "No broken image links after migration"
    - "Gallery metadata persists in Vercel KV instead of db.json"
  artifacts:
    - path: "scripts/migrate-gallery-to-cloudinary.ts"
      provides: "Migration script to upload existing images to Cloudinary"
      min_lines: 50
    - path: "scripts/init-vercel-kv.ts"
      provides: "Script to initialize Vercel KV with migrated data"
      min_lines: 20
    - path: "src/app/api/gallery/route.ts"
      provides: "Updated API routes using Vercel KV"
      exports: ["GET", "POST", "PATCH", "DELETE"]
    - path: "src/components/Gallery.tsx"
      provides: "Gallery component using CldImage from next-cloudinary"
      contains: "CldImage"
    - path: "next.config.js"
      provides: "Cloudinary domain in remotePatterns"
      contains: "res.cloudinary.com"
  key_links:
    - from: "src/components/Gallery.tsx"
      to: "Cloudinary CDN"
      via: "CldImage component with public_id"
      pattern: "CldImage.*src=\\{image\\.src\\}"
    - from: "src/app/api/gallery/route.ts"
      to: "lib/kv.ts"
      via: "getGalleryData and saveGalleryData functions"
      pattern: "(getGalleryData|saveGalleryData)"
    - from: "scripts/migrate-gallery-to-cloudinary.ts"
      to: "Cloudinary SDK"
      via: "cloudinary.uploader.upload"
      pattern: "cloudinary\\.uploader\\.upload"
---

<objective>
Migrate existing gallery from local filesystem to Cloudinary CDN with Vercel KV metadata storage.

Purpose: Solve production persistence bug (gallery changes lost on redeployment) and enable CDN delivery with automatic optimization.

Output: All 12 existing gallery images hosted on Cloudinary, gallery displaying optimized images with lazy loading, metadata persisted in Vercel KV.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/evan/Projects/clients/timberandthreads/.planning/PROJECT.md
@/home/evan/Projects/clients/timberandthreads/.planning/ROADMAP.md
@/home/evan/Projects/clients/timberandthreads/.planning/STATE.md
@/home/evan/Projects/clients/timberandthreads/.planning/research/phase-2-RESEARCH.md
@/home/evan/Projects/clients/timberandthreads/.planning/codebase/ARCHITECTURE.md
@/home/evan/Projects/clients/timberandthreads/.planning/codebase/STRUCTURE.md

# Source files to modify
@/home/evan/Projects/clients/timberandthreads/src/app/api/gallery/route.ts
@/home/evan/Projects/clients/timberandthreads/src/app/api/gallery/types.ts
@/home/evan/Projects/clients/timberandthreads/src/components/Gallery.tsx
@/home/evan/Projects/clients/timberandthreads/next.config.js
@/home/evan/Projects/clients/timberandthreads/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration scripts and migrate existing images to Cloudinary</name>
  <files>
    scripts/migrate-gallery-to-cloudinary.ts
    scripts/init-vercel-kv.ts
  </files>
  <action>
Create two migration scripts per research recommendations (Phase 2 RESEARCH.md, section "Pitfall 3: Not Migrating Existing Images"):

**scripts/migrate-gallery-to-cloudinary.ts:**
- Import cloudinary SDK, fs/promises, path
- Configure cloudinary with environment variables (CLOUDINARY_CLOUD_NAME, CLOUDINARY_API_KEY, CLOUDINARY_API_SECRET)
- Read existing db.json from src/app/api/gallery/db.json
- For each image in db.images array:
  - Check if src starts with '/assets/gallery/' (local image)
  - Upload local file from public/assets/gallery/ to Cloudinary with folder: `timber-threads/${section.toLowerCase()}`
  - Use path.basename(image.src, extname) as public_id to maintain recognizable names
  - Update image.src to Cloudinary public_id (e.g., 'timber-threads/facility/hero-front-view')
  - Add metadata.cloudinaryAssetId and metadata.format from upload result
  - Log each migration: filename -> public_id
- Write updated db.json back to src/app/api/gallery/db.json
- Log completion message

**scripts/init-vercel-kv.ts:**
- Import kv from @vercel/kv, fs/promises, path
- Read migrated db.json from src/app/api/gallery/db.json
- Initialize Vercel KV with: await kv.set('gallery', db)
- Log success message with image count

Run migration script: `npx tsx scripts/migrate-gallery-to-cloudinary.ts`
Then run init script: `npx tsx scripts/init-vercel-kv.ts`

Requirements: INFRA-01 (Vercel KV for persistence), INFRA-02 (images on Cloudinary), GALL-01 (foundation for admin uploads)
  </action>
  <verify>
Migration script runs without errors and logs 12 successful uploads. Check Cloudinary Media Library at https://console.cloudinary.com shows 12 images in timber-threads folder (8 Facility, 4 Quilting). Run init script and verify with: `npx tsx -e "import {kv} from '@vercel/kv'; const data = await kv.get('gallery'); console.log(data);"` shows migrated data.
  </verify>
  <done>
All 12 existing gallery images uploaded to Cloudinary with public_ids like 'timber-threads/facility/hero-front-view', db.json updated with Cloudinary public_ids, Vercel KV initialized with migrated data containing 12 images.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Gallery component to use CldImage with lazy loading</name>
  <files>
    src/components/Gallery.tsx
    src/app/api/gallery/types.ts
    next.config.js
  </files>
  <action>
Update Gallery component per research Pattern 1 (Phase 2 RESEARCH.md):

**src/components/Gallery.tsx:**
- Import CldImage from 'next-cloudinary' (replace next/image import)
- In the gallery grid map (lines 98-123 for Facility, similar for Quilting):
  - Replace `<Image>` with `<CldImage>`
  - Change `fill` prop to explicit `width={800}` and `height={450}`
  - Add `crop="fill"` and `gravity="auto"` for smart cropping
  - Add `loading={index < 6 ? 'eager' : 'lazy'}` for lazy loading (GALL-06 requirement)
  - Keep existing `sizes` prop: "(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
  - Remove `quality` and `priority` props (CldImage handles automatically)
  - `src` prop now receives Cloudinary public_id directly (e.g., 'timber-threads/facility/hero-front-view')
- Update for BOTH Facility and Quilting image sections

**src/app/api/gallery/types.ts:**
- Add optional fields to ImageAsset interface:
  - `cloudinaryUrl?: string` (optional full URL for reference)
  - Update metadata interface to include:
    - `cloudinaryAssetId?: string` (Cloudinary's internal asset ID)
    - `format?: string` (original format like 'jpg', 'png')

**next.config.js:**
- Change `images.unoptimized: true` to `unoptimized: false` to re-enable optimization
- Update remotePatterns from wildcard `hostname: '**'` to specific Cloudinary domain:
  ```javascript
  remotePatterns: [
    {
      protocol: 'https',
      hostname: 'res.cloudinary.com',
      pathname: `/${process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME}/**`,
    },
  ]
  ```
- Add environment variable check or fallback for NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME

Requirements: GALL-05 (WebP/AVIF optimization), GALL-06 (lazy loading), INFRA-04 (re-enable image optimization), INFRA-05 (Cloudinary remotePatterns)
  </action>
  <verify>
Run `npm run dev` and visit http://localhost:3000. Open browser DevTools Network tab and scroll gallery. Verify: (1) First 6 images load immediately with `loading="eager"`, (2) Remaining images load as lazy with `loading="lazy"`, (3) Images served as WebP or AVIF (check Content-Type headers), (4) All images display from res.cloudinary.com domain, (5) No 400 errors or broken images, (6) Image transformations include `f_auto`, `q_auto` in Cloudinary URLs (visible in Network tab).
  </verify>
  <done>
Gallery component renders all images using CldImage with Cloudinary public_ids, first 6 images load eagerly and rest lazy-load on scroll, images automatically optimized to WebP/AVIF, next.config.js allows Cloudinary domain with optimization enabled.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Gallery API routes to use Vercel KV and Cloudinary</name>
  <files>
    src/app/api/gallery/route.ts
  </files>
  <action>
Update API routes per research Pattern 3 and Pattern 5 (Phase 2 RESEARCH.md):

Assuming Phase 1 delivered lib/kv.ts with getGalleryData() and saveGalleryData() functions:

**If lib/kv.ts does NOT exist, create it:**
```typescript
// src/lib/kv.ts
import { kv } from '@vercel/kv';
import { GalleryState } from '@/app/api/gallery/types';

export async function getGalleryData(): Promise<GalleryState> {
  const data = await kv.get<GalleryState>('gallery');
  return data || { images: [], deletedImages: [] };
}

export async function saveGalleryData(data: GalleryState): Promise<void> {
  await kv.set('gallery', data);
}
```

**src/app/api/gallery/route.ts:**
- Remove all fs/promises imports and file system operations (readFile, writeFile)
- Remove getDB() and saveDB() functions (lines 11-42 in current implementation)
- Add import: `import { getGalleryData, saveGalleryData } from '@/lib/kv';`
- Add import: `import { v2 as cloudinary } from 'cloudinary';`
- Add Cloudinary config at top of file:
  ```typescript
  cloudinary.config({
    cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
    api_key: process.env.CLOUDINARY_API_KEY,
    api_secret: process.env.CLOUDINARY_API_SECRET,
  });
  ```

**Update GET handler:**
- Replace `const data = await getDB();` with `const data = await getGalleryData();`

**Update POST handler (upload):**
- Keep existing FormData handling
- Replace Sharp processing and local file save with Cloudinary upload:
  ```typescript
  const bytes = await file.arrayBuffer();
  const buffer = Buffer.from(bytes);

  const uploadResult = await new Promise((resolve, reject) => {
    cloudinary.uploader.upload_stream(
      {
        folder: `timber-threads/${section.toLowerCase()}`,
        transformation: [
          { width: 1920, height: 1080, crop: 'limit' },
          { quality: 'auto:good', fetch_format: 'auto' }
        ],
      },
      (error, result) => {
        if (error) reject(error);
        else resolve(result);
      }
    ).end(buffer);
  });
  ```
- Update newImage object: src = uploadResult.public_id (not local path), add metadata.cloudinaryAssetId and metadata.format
- Replace `await saveDB(db);` with `await saveGalleryData(db);`

**Update PATCH handler:**
- Replace `const db = await getDB();` with `const db = await getGalleryData();`
- Replace `await saveDB(db);` with `await saveGalleryData(db);`
- No other changes needed (action handlers work with Cloudinary public_ids same as local paths)

**Update DELETE handler (permanent delete):**
- Replace `const db = await getDB();` with `const db = await getGalleryData();`
- Add Cloudinary deletion before metadata removal:
  ```typescript
  try {
    await cloudinary.uploader.destroy(src); // src is Cloudinary public_id
    console.log('Deleted from Cloudinary:', src);
  } catch (error) {
    console.error('Cloudinary deletion error:', error);
    // Continue with metadata deletion even if Cloudinary fails
  }
  ```
- Replace `await saveDB(db);` with `await saveGalleryData(db);`

Requirements: INFRA-01 (KV persistence), GALL-01 (admin upload foundation), GALL-04 (delete functionality)
  </action>
  <verify>
Run `npm run dev` and test API endpoints:
1. GET /api/gallery returns data from Vercel KV (not db.json): `curl http://localhost:3000/api/gallery | jq '.images | length'` shows 12 images
2. Verify images have Cloudinary public_ids (not /assets/gallery/ paths): `curl http://localhost:3000/api/gallery | jq '.images[0].src'` returns something like "timber-threads/facility/hero-front-view"
3. Test PATCH action (edit caption): Use admin UI or curl to update a caption, reload page, verify change persists in Vercel KV
  </verify>
  <done>
Gallery API routes read/write from Vercel KV instead of db.json, POST handler uploads to Cloudinary and stores public_ids, DELETE handler removes from both Cloudinary and KV, all PATCH actions persist correctly.
  </done>
</task>

</tasks>

<verification>
**Integration verification:**

1. **Gallery display works end-to-end:**
   - Visit http://localhost:3000
   - Scroll to gallery section
   - All 12 images display correctly from Cloudinary
   - Open DevTools Network tab, reload page
   - Verify first 6 images have `loading="eager"`, rest have `loading="lazy"`
   - Verify images served as WebP or AVIF (check Content-Type response headers)
   - No 404 errors or broken image icons

2. **Metadata persistence:**
   - Stop dev server and restart: `npm run dev`
   - Gallery still shows all 12 images (not lost on restart)
   - Check Vercel KV dashboard or run: `npx tsx -e "import {kv} from '@vercel/kv'; console.log(await kv.get('gallery'));"` to verify data persists

3. **No broken links:**
   - Check browser console for no 404 errors
   - Check Cloudinary URLs are properly formed: https://res.cloudinary.com/{CLOUD_NAME}/image/upload/...
   - All images load successfully

4. **Production readiness:**
   - Deploy to Vercel preview: `vercel --prod=false`
   - Visit preview URL, verify gallery works in production environment
   - Check Vercel logs for no errors related to file system operations
</verification>

<success_criteria>
- [ ] All 12 existing gallery images are hosted on Cloudinary CDN (visible in Cloudinary Media Library)
- [ ] Gallery displays images with automatic format optimization (WebP/AVIF based on browser support)
- [ ] Gallery implements lazy loading: first 6 images eager, remaining lazy on scroll
- [ ] No broken image links or 404 errors on homepage gallery
- [ ] Gallery metadata persists in Vercel KV across server restarts
- [ ] API routes use getGalleryData/saveGalleryData instead of file system operations
- [ ] next.config.js enables optimization and allows Cloudinary domain
- [ ] Vercel preview deployment shows working gallery with all images from Cloudinary
</success_criteria>

<output>
After completion, create `.planning/phases/02-gallery-migration/02-01-SUMMARY.md` documenting:
- Number of images migrated (12 total: 8 Facility, 4 Quilting)
- Cloudinary public_id structure used (timber-threads/{section}/{filename})
- Confirmation that lazy loading works (first 6 eager, rest lazy)
- Verification that format optimization is active (WebP/AVIF)
- Any issues encountered during migration and how they were resolved
- Cloudinary bandwidth usage baseline for monitoring
</output>
