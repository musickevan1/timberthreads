---
phase: 02-gallery-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/migrate-gallery-to-cloudinary.ts
  - scripts/verify-migration.ts
  - scripts/tsconfig.json
autonomous: true

must_haves:
  truths:
    - "All existing local gallery images are uploaded to Cloudinary CDN"
    - "Redis metadata updated from local paths to Cloudinary public_ids"
    - "No local paths remain in Redis gallery data after migration"
    - "All migrated images are accessible via Cloudinary URLs"
    - "Image order, captions, sections, and metadata preserved through migration"
  artifacts:
    - path: "scripts/migrate-gallery-to-cloudinary.ts"
      provides: "One-time migration script"
      contains: "cloudinary.uploader.upload"
    - path: "scripts/verify-migration.ts"
      provides: "Post-migration verification"
      contains: "verifyMigration"
  key_links:
    - from: "scripts/migrate-gallery-to-cloudinary.ts"
      to: "src/lib/redis.ts"
      via: "getGalleryData/saveGalleryData imports"
      pattern: "getGalleryData|saveGalleryData"
    - from: "scripts/migrate-gallery-to-cloudinary.ts"
      to: "Cloudinary API"
      via: "cloudinary.uploader.upload"
      pattern: "cloudinary\\.uploader\\.upload"
    - from: "scripts/verify-migration.ts"
      to: "Cloudinary CDN"
      via: "HTTP HEAD requests to verify image accessibility"
      pattern: "res\\.cloudinary\\.com"
---

<objective>
Migrate all existing local gallery images to Cloudinary CDN and update Redis metadata.

Purpose: Phase 1 left existing images as local files in public/assets/gallery/ while new uploads go to Cloudinary. This plan migrates the ~14 existing local images so ALL gallery images are Cloudinary-hosted, eliminating the hybrid storage state and enabling CldImage component usage in Plan 02.

Output: Migration script, verification script, all images on Cloudinary with Redis metadata updated.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-gallery-migration/02-RESEARCH.md
@.planning/phases/01-infrastructure/01-03-SUMMARY.md

@src/lib/redis.ts
@src/lib/cloudinary.ts
@src/app/api/gallery/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration and verification scripts</name>
  <files>scripts/migrate-gallery-to-cloudinary.ts, scripts/verify-migration.ts, scripts/tsconfig.json</files>
  <action>
Create a `scripts/` directory at project root with three files:

**scripts/tsconfig.json** - TypeScript config for scripts that can resolve the src/ path aliases:
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "esModuleInterop": true,
    "resolveJsonModule": true,
    "strict": true,
    "paths": { "@/*": ["../src/*"] },
    "baseUrl": "."
  },
  "include": ["./**/*.ts"]
}
```

**scripts/migrate-gallery-to-cloudinary.ts** - Migration script that:

1. Loads environment variables from `.env.local` using `dotenv` (install as devDependency if not present, or use `--require dotenv/config` approach via inline require).
2. Imports Cloudinary SDK (configure directly, NOT importing from src/lib/cloudinary.ts since that uses Next.js module resolution). Configure cloudinary v2 inline with process.env values.
3. Connects to Redis using `@upstash/redis` REST client (configure directly with process.env.UPSTASH_REDIS_REST_URL and UPSTASH_REDIS_REST_TOKEN). Do NOT import from src/lib/redis.ts - the path aliases won't resolve in a standalone script.
4. Fetches current gallery data from Redis key 'gallery'.
5. Filters for images where `src` starts with `/` (local paths).
6. For each local image:
   - Constructs local file path: `path.join(process.cwd(), 'public', image.src)`
   - Verifies file exists with `fs.access()`
   - Uploads to Cloudinary with: `folder: 'timber-threads/gallery'`, `public_id` derived from filename (strip extension), `tags: [image.section.toLowerCase(), 'gallery', 'migrated']`
   - Implements retry logic (3 attempts with exponential backoff: 1s, 2s, 4s)
   - Logs success/failure for each image
7. After all uploads: updates Redis gallery data, replacing local `src` paths with Cloudinary `public_id` values for successfully migrated images. Preserves ALL other fields (alt, caption, section, order, metadata, isDeleted, deletedAt).
8. Does NOT process `deletedImages` array - soft-deleted images stay as-is (per research: avoid paying for Cloudinary storage of deleted images).
9. Writes migration log to `migration-log.json` at project root.
10. Prints summary: X succeeded, Y failed, Z skipped (already Cloudinary).

Important: The script must be runnable with `npx tsx scripts/migrate-gallery-to-cloudinary.ts` (tsx can execute TypeScript directly without compilation). Use `require('dotenv').config({ path: '.env.local' })` at the top of the script to load env vars.

**scripts/verify-migration.ts** - Verification script that:

1. Loads env vars and connects to Redis (same approach as migration script).
2. Fetches gallery data from Redis.
3. Checks all active images have Cloudinary public_ids (no local paths starting with `/`).
4. For each image, verifies accessibility by making a HEAD request to `https://res.cloudinary.com/${cloud_name}/image/upload/${image.src}`.
5. Checks metadata integrity: all images have alt, caption, section, and numeric order.
6. Checks order consistency per section (sequential, no gaps).
7. Prints report: total images, accessible count, metadata issues, order issues.
8. Exits with code 0 if all checks pass, code 1 if any fail.

Runnable with `npx tsx scripts/verify-migration.ts`.
  </action>
  <verify>
    - `ls scripts/migrate-gallery-to-cloudinary.ts scripts/verify-migration.ts scripts/tsconfig.json` shows all three files exist
    - `npx tsx --version` confirms tsx is available (install with `npm install -D tsx` if needed)
    - Scripts have no TypeScript compilation errors: `npx tsc --noEmit -p scripts/tsconfig.json` (or just verify tsx can parse them)
  </verify>
  <done>Migration and verification scripts exist, are syntactically valid TypeScript, and can be executed with npx tsx.</done>
</task>

<task type="auto">
  <name>Task 2: Run migration and verify all images on Cloudinary</name>
  <files>migration-log.json</files>
  <action>
Execute the migration and verification:

1. First, do a DRY RUN sanity check: Read current Redis gallery data via `npx tsx -e "..."` or a small inline script to confirm how many local images exist and print their paths. This validates Redis connectivity and identifies what will be migrated.

2. Run the migration script: `npx tsx scripts/migrate-gallery-to-cloudinary.ts`
   - Watch for: all images should show success messages
   - Expected: ~14 local images migrated (bathroom.jpeg, bedroom-1.jpeg, bedroom-2.jpeg, entrance-driveway.jpeg, hero-front-view.jpeg, hero-porch-view.jpeg, kitchen.jpeg, quilt-display-1.jpeg, quilt-display-2.jpeg, quilt-display-3.jpeg, quilt-workspace.jpeg, workshop.jpeg, plus possibly hero.jpg and logo.png)
   - Note: hero.jpg and logo.png may or may not be in Redis gallery data - they may be used directly in page components rather than via the gallery API. Only images in Redis gallery data will be migrated.

3. Run the verification script: `npx tsx scripts/verify-migration.ts`
   - Should exit with code 0
   - All images should be accessible on Cloudinary
   - No local paths should remain

4. Review migration-log.json to confirm all results.

5. If any images failed: examine error, fix, and re-run. The script should be idempotent for failed images (re-uploading to same public_id overwrites cleanly in Cloudinary).

If Redis does not have gallery data yet (empty gallery), the migration script should handle this gracefully - log "No local images found to migrate" and exit cleanly. In this case, the migration is a no-op and Plan 02 can proceed.
  </action>
  <verify>
    - `npx tsx scripts/verify-migration.ts` exits with code 0
    - `migration-log.json` exists and shows all images as success: true
    - No images in Redis have src starting with `/`
  </verify>
  <done>All local gallery images are uploaded to Cloudinary CDN. Redis metadata updated with Cloudinary public_ids. Verification script confirms 100% accessibility and metadata integrity.</done>
</task>

</tasks>

<verification>
- Migration script exists and ran successfully
- Verification script confirms all images accessible on Cloudinary
- Redis gallery data contains zero local paths (no src starting with `/`)
- migration-log.json shows all successes
- Image order, captions, and sections preserved (verification script checks this)
</verification>

<success_criteria>
- All ~14 local gallery images are hosted on Cloudinary CDN
- Redis metadata uses Cloudinary public_ids, not local paths
- Verification script passes with exit code 0
- No broken image links (all Cloudinary URLs return 200 on HEAD request)
</success_criteria>

<output>
After completion, create `.planning/phases/02-gallery-migration/02-01-SUMMARY.md`
</output>
