---
phase: 02-gallery-migration
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/api/cloudinary-signature/route.ts
  - src/app/admin/gallery/page.tsx
  - src/app/admin/gallery/components/UploadSection.tsx
autonomous: false

user_setup:
  - service: cloudinary
    why: "Secure image uploads via signed uploads"
    env_vars:
      - name: CLOUDINARY_CLOUD_NAME
        source: "Cloudinary Dashboard -> Account Details"
      - name: CLOUDINARY_API_KEY
        source: "Cloudinary Dashboard -> Account Details"
      - name: CLOUDINARY_API_SECRET
        source: "Cloudinary Dashboard -> Account Details (keep secret)"
    dashboard_config: []
  - service: vercel
    why: "KV storage for gallery metadata"
    env_vars:
      - name: KV_URL
        source: "Auto-configured by Vercel KV addon"
      - name: KV_REST_API_URL
        source: "Auto-configured by Vercel KV addon"
      - name: KV_REST_API_TOKEN
        source: "Auto-configured by Vercel KV addon"
    dashboard_config:
      - task: "Add Vercel KV storage addon"
        location: "Vercel Dashboard -> Project -> Storage -> Create Database -> KV"

must_haves:
  truths:
    - "Admin can upload new images to Cloudinary via gallery management UI"
    - "Admin can reorder gallery images with changes persisting in Vercel KV"
    - "Admin can edit captions with changes persisting in Vercel KV"
    - "Admin can soft-delete and restore images with changes persisting"
    - "All admin operations work in Vercel preview deployment"
  artifacts:
    - path: "src/app/api/cloudinary-signature/route.ts"
      provides: "Server-side signature generation for secure uploads"
      exports: ["POST"]
    - path: "src/app/admin/gallery/components/UploadSection.tsx"
      provides: "Upload UI using CldUploadWidget"
      contains: "CldUploadWidget"
    - path: "src/app/admin/gallery/page.tsx"
      provides: "Admin gallery management with working operations"
      min_lines: 200
  key_links:
    - from: "src/app/admin/gallery/components/UploadSection.tsx"
      to: "/api/cloudinary-signature"
      via: "CldUploadWidget signatureEndpoint prop"
      pattern: "signatureEndpoint.*cloudinary-signature"
    - from: "src/app/admin/gallery/page.tsx"
      to: "/api/gallery"
      via: "fetch calls for PATCH actions"
      pattern: "fetch.*api/gallery.*action="
    - from: "CldUploadWidget"
      to: "Cloudinary API"
      via: "onSuccess callback saving to Vercel KV"
      pattern: "onSuccess.*result\\.info"
---

<objective>
Enable full admin gallery management functionality with Cloudinary uploads and Vercel KV persistence.

Purpose: Complete gallery migration by enabling admin to upload, reorder, edit, and delete images with all changes persisting in production.

Output: Working admin interface for gallery management with signed Cloudinary uploads and verified persistence.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/evan/Projects/clients/timberandthreads/.planning/PROJECT.md
@/home/evan/Projects/clients/timberandthreads/.planning/ROADMAP.md
@/home/evan/Projects/clients/timberandthreads/.planning/STATE.md
@/home/evan/Projects/clients/timberandthreads/.planning/research/phase-2-RESEARCH.md

# Depends on Plan 02-01 deliverables
@/home/evan/Projects/clients/timberandthreads/.planning/phases/02-gallery-migration/02-01-SUMMARY.md

# Source files to modify
@/home/evan/Projects/clients/timberandthreads/src/app/admin/gallery/page.tsx
@/home/evan/Projects/clients/timberandthreads/src/app/admin/gallery/components/UploadSection.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Cloudinary signature endpoint for secure uploads</name>
  <files>
    src/app/api/cloudinary-signature/route.ts
  </files>
  <action>
Create signed upload endpoint per research Pattern 4 (Phase 2 RESEARCH.md, "Signed Uploads for Security"):

**src/app/api/cloudinary-signature/route.ts (NEW FILE):**
- Import v2 as cloudinary from 'cloudinary'
- Import NextRequest, NextResponse from 'next/server'
- Configure Cloudinary with environment variables (same config as gallery route)
- Export async POST handler:
  - Parse request body: `const body = await request.json();`
  - Extract paramsToSign from body
  - Validate paramsToSign exists (return 400 if missing)
  - Generate signature using Cloudinary SDK:
    ```typescript
    const signature = cloudinary.utils.api_sign_request(
      paramsToSign,
      process.env.CLOUDINARY_API_SECRET!
    );
    ```
  - Return JSON response: `{ signature }`
  - Add error handling with try-catch, return 500 on failure

**Why signed uploads:**
- Prevents unauthorized uploads to Cloudinary account
- API secret never exposed to client-side code
- Recommended for production environments (vs unsigned upload presets)

Requirements: INFRA-03 (signed uploads for admin security), GALL-01 (admin upload foundation)
  </action>
  <verify>
Test signature endpoint manually: `curl -X POST http://localhost:3000/api/cloudinary-signature -H "Content-Type: application/json" -d '{"paramsToSign":{"timestamp":1234567890,"folder":"test"}}'` returns JSON with signature field. Verify signature is a non-empty string.
  </verify>
  <done>
Cloudinary signature endpoint exists at /api/cloudinary-signature, generates valid signatures for upload requests, validates input and handles errors properly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update admin upload UI to use Cloudinary signed uploads</name>
  <files>
    src/app/admin/gallery/components/UploadSection.tsx
    src/app/admin/gallery/page.tsx
  </files>
  <action>
Update admin upload interface per research Pattern 2 (Phase 2 RESEARCH.md):

Two approaches - choose the simpler CldUploadWidget approach for this implementation:

**Option 1: CldUploadWidget (RECOMMENDED - use this):**

Update **src/app/admin/gallery/components/UploadSection.tsx:**
- Import CldUploadWidget from 'next-cloudinary'
- Replace existing file input and upload button with CldUploadWidget component
- Configure widget:
  ```typescript
  <CldUploadWidget
    uploadPreset="timber-threads-unsigned"  // Or use signatureEndpoint instead
    signatureEndpoint="/api/cloudinary-signature"  // For signed uploads (recommended)
    folder={`timber-threads/${activeTab.toLowerCase()}`}  // Organize by section
    onSuccess={(result) => {
      if (result.event === 'success' && result.info) {
        const uploadedImage = {
          src: result.info.public_id,
          alt: result.info.original_filename,
          caption: result.info.original_filename.replace(/[-_]/g, ' '),
          section: activeTab === 'Facility' ? 'Facility' : 'Quilting',
          metadata: {
            uploadedAt: new Date().toISOString(),
            dimensions: {
              width: result.info.width,
              height: result.info.height,
            },
            cloudinaryAssetId: result.info.asset_id,
            format: result.info.format,
          },
        };
        // Call parent handler to save to Vercel KV
        onUploadSuccess(uploadedImage);
      }
    }}
    onError={(error) => {
      console.error('Upload error:', error);
      // Call parent error handler
      onUploadError(error.message);
    }}
  >
    {({ open }) => (
      <button
        onClick={() => open()}
        className="px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700"
      >
        Upload Image to Cloudinary
      </button>
    )}
  </CldUploadWidget>
  ```
- Add onUploadSuccess and onUploadError props to UploadSection component interface
- Remove old file input, FormData, and manual fetch to POST /api/gallery

Update **src/app/admin/gallery/page.tsx:**
- Add handleUploadSuccess function that receives uploadedImage object
- Function should save to Vercel KV by calling existing API or directly:
  ```typescript
  const handleUploadSuccess = async (uploadedImage) => {
    const db = await fetch('/api/gallery').then(r => r.json());

    const maxOrder = db.images
      .filter(img => img.section === uploadedImage.section)
      .reduce((max, img) => Math.max(max, img.order || 0), 0);

    uploadedImage.order = maxOrder + 1;

    // Save to KV via API
    const response = await fetch('/api/gallery', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: uploadedImage, skipUpload: true }),
    });

    if (response.ok) {
      // Refresh gallery data
      fetchGalleryData();
    }
  };
  ```
- OR update POST /api/gallery to accept pre-uploaded image metadata (add skipUpload flag)
- Pass handleUploadSuccess to UploadSection as onUploadSuccess prop

**Alternative Option 2: Keep manual upload, update to use Cloudinary API**
If CldUploadWidget doesn't work, update existing POST handler in src/app/api/gallery/route.ts to upload to Cloudinary (already done in Plan 02-01 Task 3).

Requirements: GALL-01 (admin can upload images), GALL-02 (foundation for reorder/edit/delete)
  </action>
  <verify>
Run `npm run dev`, visit http://localhost:3000/admin (login with ADMIN_PASSWORD), navigate to /admin/gallery. Click "Upload Image to Cloudinary" button. Widget opens, select a test image, upload completes. Verify: (1) Image appears in Cloudinary Media Library under timber-threads/{section} folder, (2) Image appears in admin gallery grid, (3) Image persists after page reload, (4) Image appears on public gallery at http://localhost:3000.
  </verify>
  <done>
Admin can upload new images via CldUploadWidget, images save to Cloudinary and metadata persists in Vercel KV, uploaded images appear immediately in admin gallery and on public gallery after refresh.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Full admin gallery management with Cloudinary integration: upload, reorder, edit captions, soft-delete, restore, and permanent delete.
  </what-built>
  <how-to-verify>
**Test complete admin workflow in local development:**

1. **Upload test:**
   - Visit http://localhost:3000/admin/gallery (login if needed)
   - Click "Upload Image to Cloudinary"
   - Select a test image from your computer
   - Verify image uploads and appears in grid
   - Check Cloudinary dashboard at https://console.cloudinary.com - image should be in timber-threads folder

2. **Reorder test:**
   - Drag an image to different position in gallery grid
   - Reload page (Cmd+R / Ctrl+R)
   - Verify new order persists

3. **Edit caption test:**
   - Click "Edit" on an image
   - Change caption text
   - Save changes
   - Reload page
   - Verify updated caption persists

4. **Soft delete test:**
   - Click "Delete" on an image
   - Confirm deletion
   - Image should move to "Deleted" tab
   - Check public gallery at http://localhost:3000 - image should NOT appear
   - Switch to "Deleted" tab in admin
   - Verify image appears there

5. **Restore test:**
   - In "Deleted" tab, click "Restore" on the deleted image
   - Image should return to Facility or Quilting tab
   - Check public gallery - image should reappear

6. **Permanent delete test:**
   - Soft-delete an image again
   - In "Deleted" tab, click "Delete Permanently"
   - Confirm permanent deletion
   - Verify image removed from Cloudinary dashboard
   - Verify image no longer in admin interface

7. **Production deployment test:**
   - Deploy to Vercel preview: `vercel --prod=false`
   - Visit preview URL /admin/gallery
   - Test upload, reorder, edit caption
   - Reload page and verify all changes persist
   - Check public gallery shows correct images

**Expected outcomes:**
- All operations complete successfully
- All changes persist after page reload (both local and Vercel preview)
- No errors in browser console
- No 404 or 500 errors in Network tab
- Public gallery reflects admin changes
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass, or describe which operations failed and any error messages seen.
  </resume-signal>
</task>

</tasks>

<verification>
**Overall Phase 2 verification:**

1. **Requirements coverage:**
   - GALL-01: Admin can upload images via Cloudinary widget ✓
   - GALL-02: Admin can reorder with persistence ✓
   - GALL-03: Admin can edit captions with persistence ✓
   - GALL-04: Admin can soft-delete and restore with persistence ✓
   - GALL-05: Gallery displays with WebP/AVIF optimization ✓
   - GALL-06: Gallery lazy-loads (first 6 eager, rest lazy) ✓

2. **No broken links:**
   - Public gallery shows all images from Cloudinary
   - No 404 errors on image loads
   - All Cloudinary URLs properly formed

3. **Production readiness:**
   - Vercel preview deployment works
   - All admin operations persist in production
   - No file system operations in API routes
   - Cloudinary bandwidth within free tier limits (monitor in dashboard)

4. **Integration with Phase 1:**
   - Vercel KV storing gallery metadata
   - Cloudinary hosting all images
   - No db.json file operations in production
</verification>

<success_criteria>
- [ ] Admin can upload new images to Cloudinary via gallery management UI (GALL-01)
- [ ] Admin can reorder images with changes persisting across reloads (GALL-02)
- [ ] Admin can edit captions with changes persisting in Vercel KV (GALL-03)
- [ ] Admin can soft-delete and restore images with changes persisting (GALL-04)
- [ ] All admin operations work in Vercel preview deployment (production environment)
- [ ] Signature endpoint securely generates upload signatures (INFRA-03)
- [ ] No errors in production deployment logs
- [ ] Gallery displays correctly on public site after admin changes
</success_criteria>

<output>
After completion, create `.planning/phases/02-gallery-migration/02-02-SUMMARY.md` documenting:
- Admin upload workflow (CldUploadWidget integration)
- Verification results for all CRUD operations (upload, reorder, edit, delete, restore)
- Any issues encountered and resolutions
- Confirmation that Vercel preview deployment works
- Cloudinary bandwidth usage after testing (baseline for monitoring)
- Screenshots or recording of successful admin workflow (optional but helpful)
</output>
