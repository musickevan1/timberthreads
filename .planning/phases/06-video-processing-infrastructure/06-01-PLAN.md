---
phase: 06-video-processing-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - processing/scripts/catalog.sh
  - processing/scripts/detect-silence.sh
  - processing/catalog/metadata.json
  - processing/catalog/thumbs/
  - processing/catalog/silence-report.txt
autonomous: true

must_haves:
  truths:
    - "Every raw clip (DJI + Canon) has a metadata entry with duration, codec, resolution, framerate, filesize, and status"
    - "Every valid clip has a thumbnail image in processing/catalog/thumbs/"
    - "DJI_0018.MP4 is marked as CORRUPT in metadata and skipped without crashing the batch"
    - "All 21 Canon MVI_*.MP4 clips have silence timestamps documented in silence-report.txt"
    - "Scripts are reusable — running them again produces identical results"
  artifacts:
    - path: "processing/scripts/catalog.sh"
      provides: "Metadata extraction and thumbnail generation for all raw clips"
      contains: "DJI_0018"
    - path: "processing/scripts/detect-silence.sh"
      provides: "Silence detection for Canon interior clips"
      contains: "silencedetect"
    - path: "processing/catalog/metadata.json"
      provides: "Structured metadata for all raw clips"
      contains: "duration"
    - path: "processing/catalog/silence-report.txt"
      provides: "Silence timestamps for all Canon clips"
      contains: "silence_start"
  key_links:
    - from: "processing/scripts/catalog.sh"
      to: "processing/catalog/metadata.json"
      via: "ffprobe JSON output written to file"
      pattern: "ffprobe.*print_format json"
    - from: "processing/scripts/detect-silence.sh"
      to: "processing/catalog/silence-report.txt"
      via: "silencedetect filter output parsed and written"
      pattern: "silencedetect.*noise=.*:d="
---

<objective>
Catalog all raw footage and analyze Canon interior audio to build a complete inventory of available clips for creative editing.

Purpose: Phase 6 requires a complete picture of what footage exists (durations, codecs, resolutions) before any editing or compression can begin. The silence analysis identifies dead air in Canon interior clips so trimming decisions can be made. The corrupt DJI_0018.MP4 must be identified and documented so all downstream operations skip it gracefully.

Output: processing/catalog/ directory with metadata.json, thumbnail images, and silence-report.txt. Two reusable scripts in processing/scripts/.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-video-processing-infrastructure/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create directory structure and catalog all raw clips</name>
  <files>
    processing/scripts/catalog.sh
    processing/catalog/metadata.json
    processing/catalog/thumbs/
  </files>
  <action>
1. Create the processing directory structure:
   ```
   processing/
   ├── catalog/
   │   └── thumbs/
   ├── trimmed/
   │   ├── drone/
   │   └── interior/
   └── scripts/
   ```

2. Write `processing/scripts/catalog.sh` — a bash script that:
   - Uses `set -euo pipefail` with trap for error handling
   - Iterates over all files in `drone-clips/100MEDIA/*.MP4` and `timberandthreads-promo-clips/DCIM/100CANON/MVI_*.MP4` (note: Canon videos are MVI_*.MP4, not IMG_*.MP4; ignore CR3 photo files)
   - For DJI_0018.MP4 specifically: logs it as CORRUPT with status "CORRUPT - MOOV atom missing" and continues (PROC-04)
   - For DJI_0018.MP4_fixed.MP4: attempts ffprobe validation. If valid, catalogs it normally with a note. If invalid, logs as ERROR.
   - For each valid file, extracts via ffprobe: duration, codec_name, width, height, r_frame_rate, bit_rate, file size (via `stat -c%s`)
   - Generates a mid-point thumbnail using: `ffmpeg -ss $midpoint -i "$file" -vframes 1 -q:v 2 "processing/catalog/thumbs/${basename}.jpg" -y`
   - Calculates midpoint using awk (NOT bc — bc is not installed): `midpoint=$(echo "$duration" | awk '{printf "%.0f", $1/2}')`
   - Builds a JSON array and writes to `processing/catalog/metadata.json` using jq for proper formatting
   - JSON structure per clip: `{"filename", "path", "source" (drone|canon), "duration_sec", "codec", "resolution", "framerate", "bitrate_kbps", "filesize_bytes", "filesize_mb", "thumbnail", "status"}`
   - Prints summary at end: total clips, valid clips, corrupt/error clips, total duration

3. Make the script executable: `chmod +x processing/scripts/catalog.sh`

4. Run the script: `bash processing/scripts/catalog.sh`

5. Verify output:
   - metadata.json exists and is valid JSON (use `jq . processing/catalog/metadata.json`)
   - Thumbnail directory has one .jpg per valid clip
   - DJI_0018.MP4 appears with CORRUPT status
   - All 21 MVI_*.MP4 Canon clips appear
   - All valid DJI clips (0014, 0015, 0016, 0017, plus 0018_fixed if valid) appear

IMPORTANT corrections from research:
- Research said 5 DJI clips (0015-0019). Actual directory has DJI_0014.MP4 through DJI_0018.MP4 plus DJI_0018.MP4_fixed.MP4. There is NO DJI_0019.
- Research said Canon clips were "21 Canon interior clips in 100CANON/*.MP4". Actual directory has MVI_4248.MP4 through MVI_4270.MP4 (21 video files) PLUS 58 CR3 photo files. Only glob MVI_*.MP4 for video processing.
- bc is NOT installed. Use awk for all math operations.
  </action>
  <verify>
- `jq length processing/catalog/metadata.json` returns the expected clip count (should be ~26: 5 DJI + potentially 1 fixed + 21 Canon, minus any errors)
- `jq '.[] | select(.status == "CORRUPT")' processing/catalog/metadata.json` returns DJI_0018.MP4
- `ls processing/catalog/thumbs/*.jpg | wc -l` matches valid clip count
- `jq '.[] | select(.source == "canon")' processing/catalog/metadata.json | jq -s length` returns 21
  </verify>
  <done>
- metadata.json contains a JSON array with one entry per raw clip (DJI + Canon MVI_*)
- Each entry has all required fields: filename, path, source, duration_sec, codec, resolution, framerate, bitrate_kbps, filesize_bytes, filesize_mb, thumbnail, status
- DJI_0018.MP4 has status CORRUPT and no thumbnail
- All other clips have status OK and a corresponding thumbnail in processing/catalog/thumbs/
- catalog.sh is executable and idempotent (safe to re-run)
  </done>
</task>

<task type="auto">
  <name>Task 2: Analyze Canon clips for silence and dead air</name>
  <files>
    processing/scripts/detect-silence.sh
    processing/catalog/silence-report.txt
  </files>
  <action>
1. Write `processing/scripts/detect-silence.sh` — a bash script that:
   - Uses `set -euo pipefail` with trap for error handling
   - Iterates over all `timberandthreads-promo-clips/DCIM/100CANON/MVI_*.MP4` files (21 clips)
   - For each clip, runs FFmpeg silence detection: `ffmpeg -i "$file" -af silencedetect=noise=-30dB:d=0.5 -f null - 2>&1`
   - Parses the output to extract silence_start, silence_end, and silence_duration values
   - Writes structured output to `processing/catalog/silence-report.txt` with per-clip sections:
     ```
     === MVI_4248.MP4 ===
     Duration: 45.2s
     Silent segments: 3
       0.000 - 2.150 (2.15s) [start dead air]
       22.300 - 25.800 (3.50s) [mid-clip silence]
       43.100 - 45.200 (2.10s) [end dead air]
     Active audio: 37.45s (82.8%)

     === MVI_4249.MP4 ===
     ...
     ```
   - At the end, writes a summary section with:
     - Total clips analyzed
     - Clips with >50% silence (candidates for trimming)
     - Clips with <10% silence (mostly active, minimal trimming needed)
     - Recommended trim candidates (clips where start or end has >2s silence)
   - Uses awk for all math (no bc)

2. Make executable: `chmod +x processing/scripts/detect-silence.sh`

3. Run the script: `bash processing/scripts/detect-silence.sh`

4. Review the silence report output to verify it produced meaningful results.

Note on threshold: Start with -30dB as recommended by research. If ALL clips show as mostly silent (>80% silence), the threshold is too high — the indoor ambient noise floor may be above -30dB. In that case, re-run with -40dB and note the adjustment in the report header.
  </action>
  <verify>
- `processing/catalog/silence-report.txt` exists and is non-empty
- Report contains entries for all 21 MVI_*.MP4 files (count `===` headers)
- Report ends with a summary section
- `grep -c "===" processing/catalog/silence-report.txt` returns 21
  </verify>
  <done>
- silence-report.txt contains silence analysis for all 21 Canon MVI_*.MP4 clips
- Each clip section shows: filename, duration, silent segments with timestamps, active audio percentage
- Summary section identifies clips needing trimming (>50% silence, start/end dead air)
- detect-silence.sh is executable and idempotent
- Silence threshold is documented (-30dB or adjusted with explanation)
  </done>
</task>

</tasks>

<verification>
Phase 6 Plan 01 verification (run after both tasks complete):

1. Directory structure exists:
   ```bash
   ls -la processing/catalog/metadata.json processing/catalog/silence-report.txt
   ls processing/catalog/thumbs/ | head -5
   ls processing/scripts/catalog.sh processing/scripts/detect-silence.sh
   ```

2. Metadata completeness:
   ```bash
   jq length processing/catalog/metadata.json  # Expected: ~26 clips
   jq '[.[] | .source] | group_by(.) | map({(.[0]): length}) | add' processing/catalog/metadata.json
   ```

3. Corrupt file handling:
   ```bash
   jq '.[] | select(.status != "OK")' processing/catalog/metadata.json
   ```

4. Silence report completeness:
   ```bash
   grep -c "===" processing/catalog/silence-report.txt  # Expected: 21
   ```
</verification>

<success_criteria>
- All raw clips cataloged in metadata.json with complete metadata fields
- Thumbnails generated for every valid clip
- DJI_0018.MP4 documented as corrupt, not processed
- All 21 Canon clips analyzed for silence with timestamps
- Both scripts are reusable and idempotent
- PROC-01 satisfied (catalog with thumbnails, duration, codec, resolution)
- PROC-02 satisfied (silence analysis with timestamps)
- PROC-04 partially satisfied (corrupt file identified and documented)
</success_criteria>

<output>
After completion, create `.planning/phases/06-video-processing-infrastructure/06-01-SUMMARY.md`
</output>
