---
phase: 06-video-processing-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - processing/scripts/compress-hero.sh
  - processing/scripts/compress-promo.sh
  - processing/trimmed/drone/
  - processing/trimmed/interior/
autonomous: true

must_haves:
  truths:
    - "compress-hero.sh accepts an input file and produces a 720p H.264 MP4 under 5MB with faststart and yuv420p"
    - "compress-promo.sh accepts an input file and produces a 1080p H.264 MP4 under 10MB with faststart and yuv420p"
    - "Both compression scripts use two-pass encoding with calculated bitrate targeting (not CRF)"
    - "All valid DJI drone clips are copied to processing/trimmed/drone/ with metadata preserved"
    - "Canon clips with active audio segments are noted for Resolve import"
    - "DJI_0018.MP4 is skipped in all batch operations without error"
  artifacts:
    - path: "processing/scripts/compress-hero.sh"
      provides: "Two-pass 720p compression targeting <5MB"
      contains: "movflags +faststart"
    - path: "processing/scripts/compress-promo.sh"
      provides: "Two-pass 1080p compression targeting <10MB"
      contains: "movflags +faststart"
    - path: "processing/trimmed/drone/"
      provides: "DJI drone clips ready for Resolve import with metadata intact"
    - path: "processing/trimmed/interior/"
      provides: "Canon clips prepared for Resolve with silence notes"
  key_links:
    - from: "processing/scripts/compress-hero.sh"
      to: "output MP4 file"
      via: "two-pass ffmpeg encoding with bitrate calculation"
      pattern: "-pass 1.*-pass 2"
    - from: "processing/scripts/compress-promo.sh"
      to: "output MP4 file"
      via: "two-pass ffmpeg encoding with bitrate calculation"
      pattern: "-pass 1.*-pass 2"
    - from: "processing/catalog/silence-report.txt"
      to: "processing/trimmed/interior/"
      via: "silence report informs which Canon clips to prepare"
---

<objective>
Create reusable FFmpeg compression scripts and prepare trimmed footage segments for DaVinci Resolve import.

Purpose: Phase 8 (Web Compression) needs battle-tested compression scripts that guarantee file size targets. Phase 7 (Creative Editing) needs organized, validated clips in a clean directory with metadata preserved for Resolve's stabilization features. This plan bridges raw footage to the creative editing workflow.

Output: Two compression scripts in processing/scripts/, DJI clips in processing/trimmed/drone/ with metadata, Canon clip preparation notes in processing/trimmed/interior/.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-video-processing-infrastructure/06-RESEARCH.md
@.planning/phases/06-video-processing-infrastructure/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reusable compression scripts for hero and promo video</name>
  <files>
    processing/scripts/compress-hero.sh
    processing/scripts/compress-promo.sh
  </files>
  <action>
1. Write `processing/scripts/compress-hero.sh` — hero video compression (720p, <5MB target):
   - Accepts positional args: `$1` = input file, `$2` = output file (optional, defaults to `${input}_hero_720p.mp4`)
   - Uses `set -euo pipefail` with trap cleanup for two-pass log files
   - Validates input file exists and is readable
   - Extracts duration via ffprobe
   - Calculates video bitrate using awk (NOT bc):
     ```bash
     TARGET_SIZE_KB=4800  # 4.8MB (leave 200KB headroom under 5MB limit)
     AUDIO_BITRATE_KBPS=0  # Hero is muted (-an flag)
     video_bitrate=$(echo "$TARGET_SIZE_KB $duration" | awk '{printf "%.0f", ($1 * 8) / $2}')
     ```
   - Pass 1: `ffmpeg -i "$INPUT" -vf "scale=1280:720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2" -c:v libx264 -b:v ${video_bitrate}k -pass 1 -an -f null /dev/null -y`
   - Pass 2: `ffmpeg -i "$INPUT" -vf "scale=1280:720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2" -c:v libx264 -b:v ${video_bitrate}k -pass 2 -movflags +faststart -pix_fmt yuv420p -profile:v baseline -level 3.0 -an "$OUTPUT" -y`
   - Note: Hero video is MUTED (`-an` flag, no audio track) per HERO-01 requirement
   - After encoding, validates output file size is under 5MB using stat
   - Prints summary: input duration, output file size, target achieved (yes/no)
   - Cleans up ffmpeg2pass-*.log files in trap EXIT

2. Write `processing/scripts/compress-promo.sh` — promo video compression (1080p, <10MB target):
   - Same structure as hero script but with different parameters:
   - TARGET_SIZE_KB=9600 (9.6MB, leave 400KB headroom under 10MB)
   - AUDIO_BITRATE_KBPS=128 (AAC audio for promo)
   - No scale filter for 1080p (source is already 1080p) — but add `-vf "scale=-2:1080"` to handle any non-1080p input gracefully
   - Pass 2 includes audio: `-c:a aac -b:a 128k`
   - All browser compatibility flags: `-movflags +faststart -pix_fmt yuv420p -profile:v baseline -level 3.0`
   - Bitrate calculation accounts for audio:
     ```bash
     total_bitrate=$(echo "$TARGET_SIZE_KB $duration" | awk '{printf "%.0f", ($1 * 8) / $2}')
     video_bitrate=$(echo "$total_bitrate $AUDIO_BITRATE_KBPS" | awk '{printf "%.0f", $1 - $2}')
     ```
   - Validates output < 10MB

3. Make both scripts executable: `chmod +x processing/scripts/compress-hero.sh processing/scripts/compress-promo.sh`

4. Test compress-hero.sh against one short DJI clip to verify it produces valid output:
   ```bash
   # Use the shortest DJI clip for fast testing
   bash processing/scripts/compress-hero.sh drone-clips/100MEDIA/DJI_0014.MP4 /tmp/test-hero.mp4
   ```
   - Verify output exists, is valid MP4 (ffprobe succeeds), and check size
   - Note: DJI clips are large (665MB-1.6GB) so even a test may take a few minutes. If testing on full clips takes too long (>5 minutes), test with a 10-second trim first:
     ```bash
     ffmpeg -ss 0 -t 10 -i drone-clips/100MEDIA/DJI_0014.MP4 -c copy /tmp/test-input.mp4 -y
     bash processing/scripts/compress-hero.sh /tmp/test-input.mp4 /tmp/test-hero.mp4
     ```
   - Clean up test files after verification

5. Test compress-promo.sh similarly with a Canon clip:
   ```bash
   bash processing/scripts/compress-promo.sh timberandthreads-promo-clips/DCIM/100CANON/MVI_4248.MP4 /tmp/test-promo.mp4
   ```
   - Verify output, check for audio track, verify size
   - Clean up test files

IMPORTANT: Use awk for ALL math. bc is not installed on this system.
  </action>
  <verify>
- Both scripts exist and are executable: `ls -la processing/scripts/compress-*.sh`
- Hero script contains required flags: `grep -c "movflags +faststart\|pix_fmt yuv420p\|profile:v baseline\|-an" processing/scripts/compress-hero.sh` returns 4
- Promo script contains required flags: `grep -c "movflags +faststart\|pix_fmt yuv420p\|profile:v baseline\|aac" processing/scripts/compress-promo.sh` returns 4
- Both scripts use two-pass: `grep -c "pass 1\|pass 2" processing/scripts/compress-hero.sh` returns 2
- Test output from hero script is valid: `ffprobe -v error /tmp/test-hero.mp4` exits 0
- Test output from promo script is valid: `ffprobe -v error /tmp/test-promo.mp4` exits 0
  </verify>
  <done>
- compress-hero.sh produces 720p muted H.264 MP4 under 5MB with faststart, yuv420p, baseline profile
- compress-promo.sh produces 1080p H.264 MP4 with AAC audio under 10MB with faststart, yuv420p, baseline profile
- Both use two-pass encoding with calculated bitrate (not CRF)
- Both validate output file size and report pass/fail
- Both handle cleanup of temporary two-pass log files
- Both tested against real footage and produce valid output
- PROC-03 fully satisfied
  </done>
</task>

<task type="auto">
  <name>Task 2: Prepare trimmed drone and Canon clips for Resolve import</name>
  <files>
    processing/trimmed/drone/
    processing/trimmed/interior/
    processing/trimmed/README.md
  </files>
  <action>
1. Prepare DJI drone clips for Resolve:
   - Read processing/catalog/metadata.json to get list of valid DJI clips (status == "OK", source == "drone")
   - For each valid DJI clip, copy to processing/trimmed/drone/ preserving ALL metadata:
     ```bash
     ffmpeg -i "$source" -c copy -map_metadata 0 "processing/trimmed/drone/$(basename $source)" -y
     ```
   - Skip DJI_0018.MP4 (status CORRUPT in metadata.json)
   - For DJI_0018.MP4_fixed.MP4: include if it was cataloged as OK, skip if ERROR
   - Verify each copied file with ffprobe to confirm metadata preservation
   - Log results: "Copied N drone clips to processing/trimmed/drone/"

2. Prepare Canon interior clips for Resolve:
   - Read processing/catalog/silence-report.txt to understand which clips have significant silence
   - Copy ALL 21 Canon MVI_*.MP4 clips to processing/trimmed/interior/ using stream copy (no re-encoding):
     ```bash
     ffmpeg -i "$source" -c copy "processing/trimmed/interior/$(basename $source)" -y
     ```
   - Note: Do NOT convert 60fps to 30fps. Research recommends keeping at 60fps for DaVinci Resolve flexibility (Resolve handles framerate conversion better with optical flow).
   - Do NOT trim clips at this stage — silence report is for reference during creative editing in Phase 7. Trimming in Resolve gives more creative control.

3. Create processing/trimmed/README.md (brief, functional — NOT documentation for its own sake):
   ```
   # Trimmed Clips for DaVinci Resolve Import

   ## drone/
   DJI clips with original metadata preserved (-map_metadata 0).
   DJI_0018.MP4 excluded (corrupt MOOV atom).

   ## interior/
   Canon MVI_*.MP4 clips at original 60fps (do not convert — Resolve handles better).
   See ../catalog/silence-report.txt for dead air timestamps per clip.

   ## Resolve Import Notes
   - Import entire drone/ and interior/ folders as bins
   - Set timeline to 30fps (matches drone footage)
   - Canon 60fps clips will auto-conform in 30fps timeline
   - Check silence-report.txt before selecting interior clips for timeline
   ```

4. Verify final state:
   - Count files in processing/trimmed/drone/ matches valid DJI clips from metadata.json
   - Count files in processing/trimmed/interior/ is 21 (all Canon MVI_*.MP4)
   - Spot-check one drone clip metadata: `ffprobe -v error -show_format processing/trimmed/drone/DJI_0015.MP4 | grep -i "tag"` should show DJI metadata tags
  </action>
  <verify>
- `ls processing/trimmed/drone/*.MP4 | wc -l` matches valid DJI clip count from metadata.json
- `ls processing/trimmed/interior/*.MP4 | wc -l` returns 21
- `ffprobe -v error processing/trimmed/drone/DJI_0015.MP4` exits 0 (valid file)
- `ffprobe -v error processing/trimmed/interior/MVI_4248.MP4` exits 0 (valid file)
- DJI_0018.MP4 does NOT exist in processing/trimmed/drone/
- processing/trimmed/README.md exists
  </verify>
  <done>
- All valid DJI drone clips copied to processing/trimmed/drone/ with metadata preserved via -map_metadata 0
- DJI_0018.MP4 excluded from trimmed output (PROC-04 skip in batch operation)
- All 21 Canon MVI_*.MP4 clips copied to processing/trimmed/interior/ at original 60fps
- README.md provides Resolve import guidance referencing silence report
- Success criteria #5 satisfied: trimmed segments exported to processing/trimmed/ preserving DJI metadata
  </done>
</task>

</tasks>

<verification>
Phase 6 Plan 02 verification (run after both tasks complete):

1. Compression scripts are complete and tested:
   ```bash
   file processing/scripts/compress-hero.sh processing/scripts/compress-promo.sh
   # Both should show "Bourne-Again shell script, ASCII text executable"
   ```

2. Scripts contain all required browser compatibility flags:
   ```bash
   for script in processing/scripts/compress-hero.sh processing/scripts/compress-promo.sh; do
     echo "=== $(basename $script) ==="
     grep -c "movflags" "$script"
     grep -c "yuv420p" "$script"
     grep -c "pass 1" "$script"
     grep -c "pass 2" "$script"
   done
   ```

3. Trimmed clips are present and valid:
   ```bash
   echo "Drone clips:"; ls processing/trimmed/drone/
   echo "Interior clips:"; ls processing/trimmed/interior/ | wc -l
   echo "Corrupt excluded:"; ls processing/trimmed/drone/DJI_0018.MP4 2>&1
   ```

4. Full Phase 6 requirement check:
   - PROC-01: metadata.json + thumbs (Plan 01)
   - PROC-02: silence-report.txt (Plan 01)
   - PROC-03: compress-hero.sh + compress-promo.sh (Plan 02 Task 1)
   - PROC-04: DJI_0018 skipped in catalog, silence, trim, and compression scripts
</verification>

<success_criteria>
- compress-hero.sh produces valid 720p muted MP4 under 5MB with all browser flags
- compress-promo.sh produces valid 1080p MP4 with audio under 10MB with all browser flags
- Both scripts use two-pass encoding (not CRF) for guaranteed file size
- All valid DJI clips are in processing/trimmed/drone/ with metadata preserved
- All 21 Canon clips are in processing/trimmed/interior/ at original 60fps
- DJI_0018.MP4 is excluded from all trimmed output
- PROC-03 fully satisfied
- PROC-04 fully satisfied (skip in all batch operations)
- Phase 6 success criteria #4 (compression scripts) and #5 (trimmed segments) met
</success_criteria>

<output>
After completion, create `.planning/phases/06-video-processing-infrastructure/06-02-SUMMARY.md`
</output>
